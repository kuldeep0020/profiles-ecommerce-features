models:
  - name: domain_profile_id_stitcher
    model_type: id_stitcher
    model_spec:
      validity_time: 24h # 1 day
      entity_key: user
      main_id_type: main_id
      edge_sources:
        - input: identifies_1
#        - input: tracks_1
#        - input: product_added_1
#        - input: order_completed_1
#        - input: checkout_steps_1
  - name: domain_profile
    model_type: feature_table_model
    model_spec:
      validity_time: 24h # 1 day
      id_stitching:
        model: domain_profile_id_stitcher
      features:

# Latest Country
        - tablevar:
            name: max_timestamp_for_country
            ref:
              input: identifies_1
            filter: properties_country is not null and properties_country != ''
            value: max(timestamp)

        - tablevar:
            name: max_timestamp_country
            ref:
              input: identifies_1
            filter: timestamp = max_timestamp_for_country and main_id is not null
            value: max(properties_country)

        - feature:
            name: latest_country
            value: max_timestamp_country

# Latest State
        - tablevar:
            name: max_timestamp_for_state
            ref:
              input: identifies_1
            filter: properties_state is not null and properties_state != ''
            value: max(timestamp)

        - tablevar:
            name: max_timestamp_state
            ref:
              input: identifies_1
            filter: timestamp = max_timestamp_for_state and main_id is not null
            value: max(properties_state)

        - feature:
            name: latest_state
            value: max_timestamp_state

# has mobile app?
        - tablevar:
            name: has_mobile_app
            ref:
              input: identifies_1
            filter: main_id is not null
            value: max(case when lower(context_device_type) in ('android', 'ios') then 1 else 0 end)

# Campaign source
        - tablevar:
            name: campaign_source
            ref:
              input: identifies_1
            filter: main_id is not null
            value: (array_agg(distinct context_campaign_source ))

# Is active on website?
        - tablefeature:
            name: is_active_on_website
            ref:
              input: identifies_1
            filter: main_id is not null
            value: max(case when lower(CONTEXT_DEVICE_TYPE) like '%pc' then 1 else 0 end)

# Payment Method
        - tablefeature:
            name: payment_methods
            ref:
              input: checkout_steps_1
            filter: main_id is not null
            value: (array_agg(distinct properties_payment_method))

# Gender
        - tablevar:
            name: max_timestamp_for_gender
            ref:
              input: identifies_1
            filter: properties_gender is not null and properties_gender != ''
            value: max(timestamp)

        - tablevar:
            name: max_timestamp_gender
            ref:
              input: identifies_1
            filter: timestamp = max_timestamp_for_gender and main_id is not null
            value: max(properties_gender)

        - feature:
            name: gender
            value: max_timestamp_gender

# Days since account creation
        - tablevar:
            name: min_timestamp_for_acc
            ref:
              input: identifies_1
            filter: timestamp is not null and timestamp != '' and main_id is not null
            value: min(timestamp)

        - tablevar:
            name: least_ref_timestamp
            ref:
              input: identifies_1
            # Here you can use any date value instead of '2022.09.23' as a reference
            value: least(TO_DATE('2022.09.23', 'YYYY.MM.DD'), CURRENT_TIMESTAMP())

        - feature:
            name: days_Since_Account_creation
            value: TO_DATE(least_ref_timestamp) - TO_DATE(min_timestamp_for_acc)

# Age
        - tablevar:
            name: max_timestamp_for_dob
            ref:
              input: identifies_1
            filter: properties_birthday is not null and properties_birthday != ''
            value: max(timestamp)

        - tablevar:
            name: max_timestamp_dob
            ref:
              input: identifies_1
            filter: timestamp = max_timestamp_for_dob and main_id is not null
            value: max(properties_birthday)

        - tablevar:
            name: age_from_dob
            ref:
              input: identifies_1
            filter: max_timestamp_dob is not null and max_timestamp_dob != ''
            value: max(CASE WHEN CURRENT_TIMESTAMP() < TO_DATE('2022.09.23', 'YYYY.MM.DD')
                    THEN
                    (CASE WHEN dateadd(year, datediff (year, max_timestamp_dob, CURRENT_TIMESTAMP()), max_timestamp_dob) > CURRENT_TIMESTAMP()
                    THEN datediff(year, max_timestamp_dob, CURRENT_TIMESTAMP()) - 1
                    ELSE datediff(year, max_timestamp_dob, CURRENT_TIMESTAMP())
                    END)
                    ELSE
                    (CASE WHEN dateadd(year, datediff (year, max_timestamp_dob, TO_DATE('2022.09.23', 'YYYY.MM.DD')), max_timestamp_dob) > TO_DATE('2022.09.23', 'YYYY.MM.DD')
                    THEN datediff(year, max_timestamp_dob, TO_DATE('2022.09.23', 'YYYY.MM.DD')) - 1
                    ELSE datediff(year, max_timestamp_dob, TO_DATE('2022.09.23', 'YYYY.MM.DD'))
                    END)
                    END)

        - feature:
            name: age_in_years
            value: age_from_dob